# Notion DB Exporter

Notion DB ExporterはNotionデータベースの内容を自動的にGoogle DocsとしてエクスポートするためのGoogle Apps Scriptプロジェクトです。Notionの各エントリーを個別のGoogle Docsドキュメントとして保存し、書式設定や画像も保持します。

## 機能

- NotionデータベースからすべてのページをGoogle Docsとして自動エクスポート
- **差分エクスポート機能** - 新規または更新されたページのみを処理（時間効率化）
- リッチテキスト書式（太字、斜体、取り消し線、コードなど）の保持
- 画像のインポート
- リスト（箇条書きと番号付き）のサポート
- 見出し、引用、コードブロックのサポート
- 処理結果の詳細なログ
- バッチ処理機能（大量データ用）- Google Apps Scriptの実行時間制限を回避

## 環境構築

### 前提条件

1. Googleアカウント
2. Notionアカウントと統合用のAPIキー
3. エクスポート対象のNotionデータベース
4. エクスポート先のGoogle Driveフォルダ

## セットアップ手順

#### 1. スプレッドシートの準備
1. [Google Sheets](https://sheets.google.com)で新しいスプレッドシートを作成
2. 「拡張機能」→「Apps Script」をクリックしてスクリプトエディタを開く
3. デフォルトの`Code.gs`ファイルを削除
4. このリポジトリの各JavaScriptファイルをインポート:
   - 各ファイルの内容をコピーして、同名の`.gs`ファイルとして貼り付け
   - 例: `main.js`の内容を`Main.gs`として保存
5. `appsscript.json`の内容を設定ファイルとして保存

#### 2. Notion API統合の設定

1. [Notion Developers](https://www.notion.so/my-integrations) ページにアクセス
2. 「New integration」をクリック
3. 統合の名前を入力し、関連するワークスペースを選択
4. 「Submit」をクリックして統合を作成
5. 表示された「Internal Integration Token」をコピー（これがAPIキーです）
6. エクスポートしたいデータベースにこの統合を接続:
   - Notionでデータベースを開く
   - 右上の「...」をクリック
   - 「Add connections」→先ほど作成した統合を選択

#### 3. Google Apps Scriptプロジェクトの作成

1. [Google Drive](https://drive.google.com)にアクセス
2. 「新規」→「その他」→「Google Apps Script」をクリック
3. プロジェクト名を「Notion DB Exporter」などに変更

#### 4. コードのインポート

1. デフォルトの`Code.gs`ファイルを削除
2. 次の7つのファイルを作成し、対応するコードをコピー&ペースト:
   - `Main.gs`
   - `NotionAPI.gs`
   - `DocsConverter.gs`
   - `Settings.gs`
   - `UIUtils.gs`
   - `BatchProcessor.gs`
   - `DifferentialExporter.gs`

#### 5. Drive APIの有効化

1. Apps Scriptエディタの左側にある「サービス」アイコンをクリック
2. 「サービスを追加」ボタンをクリック
3. リストから「Drive API」を選択し、「追加」ボタンをクリック

#### 6. スプレッドシートの作成

1. [Google Sheets](https://sheets.google.com)にアクセス
2. 新しいスプレッドシートを作成し、任意の名前を付ける
3. Apps Scriptエディタに戻り、「Deploy」→「New deployment」をクリック
4. 「Select type」で「Web app」を選択
5. 「Execute as」で「Me」を選択、「Who has access」で「Anyone」を選択
6. 「Deploy」をクリック

### 使用方法

1. 作成したスプレッドシートを開く
2. 最初の実行時は新しく追加された「Notion Export」メニューが表示されるまで、ページを更新する必要があるかもしれません
3. 「Notion Export」→「API Keyを設定」をクリックし、Notion APIキーを入力
4. 「Notion Export」→「設定シートを初期化」をクリック
5. 設定シートに以下の情報を入力:
   - NotionデータベースID: データベースのURLから取得（例: https://www.notion.so/workspace/12345678abcd1234567890abcdef1234?v=... の「12345678abcd1234567890abcdef1234」部分）
   - Google DriveフォルダID: エクスポート先フォルダのURLから取得（例: https://drive.google.com/drive/folders/1a2b3c4d5e6f7g8h9i0j? の「1a2b3c4d5e6f7g8h9i0j」部分）
6. エクスポート方法を選択:
   - **全ページをエクスポート**: すべてのページを処理します（初回実行時におすすめ）
   - **差分エクスポート**: 新規または更新されたページのみを処理します（日常的な更新用）
   - **バッチ処理でエクスポート**: 大量のデータを処理する場合（30ページ以上）

### 差分エクスポート機能の使用方法

差分エクスポートは、前回のエクスポート以降に新規作成または更新されたページのみを処理します。これにより処理時間が大幅に短縮され、Google Apps Scriptの実行時間制限（6分）内に収まるようになります。

1. 初回は「全ページをエクスポート」または「差分エクスポート」を実行
   - 初回はどちらも同じ結果になります（すべてのページが処理されます）
2. 以降は「差分エクスポート」を実行
   - Notionで追加・更新されたページのみが処理されます
   - 変更がないページは自動的にスキップされます
3. 必要に応じて「差分エクスポート情報をリセット」を実行
   - すべてのページを再処理したい場合に使用します
   - 次回の差分エクスポート実行時、すべてのページが新規として処理されます

利点:
- 処理時間の大幅な短縮
- Google Docsの更新（更新されたページは既存のドキュメントを上書き）
- エクスポート結果にスキップされたページも表示（結果の確認が容易）

### バッチ処理の使用方法

バッチ処理は、Google Apps Scriptの実行時間制限（6分）を回避するために、大きなデータベースを小さなバッチに分けて処理します。

1. 「Notion Export」→「バッチ処理でエクスポート（大量データ用）」をクリック
2. バッチ処理が開始され、「バッチステータス」シートが表示されます
3. このシートでは現在の進行状況と最新の処理結果が確認できます
4. バッチ処理中はスプレッドシートを開いたままにしてください
5. バッチ処理は自動的に次のバッチを1分間隔で実行し、すべてのページが処理されるまで続きます
6. 処理を途中で止めたい場合は「Notion Export」→「バッチ処理を停止」をクリック

バッチ処理のデフォルト設定:
- 1バッチあたり5ページを処理
- 次のバッチまで1分の間隔を空ける

これらの設定は `BatchProcessor.gs` ファイル内の `BATCH_SIZE` 変数を変更することでカスタマイズできます。

### トラブルシューティング
#### スプレッドシート連携の問題
- **メニューが表示されない**: ブラウザをリフレッシュするか、一度スプレッドシートを閉じて再度開いてください
- **「スクリプトが見つかりません」エラー**: Apps Scriptのデプロイメントが正しく設定されているか確認してください

#### Notion APIの問題
- **APIキーエラー**: APIキーが正しく設定されているか確認してください
- **データベースIDエラー**: NotionデータベースIDが正しいこと、そのデータベースに統合がアクセスできることを確認してください
- **アクセス権限エラー**: Google Driveフォルダにスクリプトからアクセスできるか確認してください
- **バッチ処理が途中で停止する**: 
  1. インターネット接続を確認してください
  2. スプレッドシートを閉じてしまった場合、再度開いて「バッチ処理でエクスポート」をクリックすると途中から再開できます
  3. エラーが続く場合は、「バッチステータス」シートを確認し、具体的なエラーメッセージを確認してください

## ファイル構成

- **Main.gs**: メインの実行関数とエントリポイント
- **NotionAPI.gs**: Notion APIとの通信処理
- **DocsConverter.gs**: NotionブロックからGoogle Docsへの変換処理
- **Settings.gs**: 設定関連の処理
- **UIUtils.gs**: UI関連の処理とユーティリティ
- **BatchProcessor.gs**: バッチ処理機能の実装
- **DifferentialExporter.gs**: 差分エクスポート機能の実装

## 制限事項

- テーブルは完全にはサポートされていません（プレースホルダを表示）
- トグルブロックは視覚的な表現のみサポート
- Notionの画像が有効期限切れの場合、挿入できないことがあります

## 使用時の注意点

1. このツールはスプレッドシートとGoogle Apps Scriptがセットで機能します
2. スプレッドシートを開いたまま処理を実行する必要があります
3. バッチ処理中はスプレッドシートを閉じないでください
4. 大量のドキュメントを処理する場合は、バッチサイズを調整してください

## よくある質問

**Q: 差分エクスポートとバッチ処理はどう使い分けるべきですか？**  
A: 差分エクスポートは日常的な更新に最適です。新規や更新されたページのみを処理するため、通常6分以内に完了します。バッチ処理は初回の全データ処理や、大規模な更新時に使用してください。

**Q: 差分エクスポート情報がリセットされたら何が起こりますか？**  
A: 次回の差分エクスポート実行時、すべてのページが新規として処理されます。これは初期状態と同じ動作になります。

**Q: 差分エクスポートでページが更新されたかどうかはどうやって判断していますか？**  
A: Notion APIが提供する `last_edited_time` を使用しています。前回のエクスポート時よりも後に編集されたページは更新対象となります。

**Q: 画像が挿入されません**  
A: Notionの画像URLには有効期限があります。定期的にエクスポートを実行するか、Notionが永続的なURLを提供するまでこの制限は続きます。

## ライセンス

MITライセンス

## 貢献

プルリクエスト大歓迎です。大きな変更を加える場合は、まずissueを開いて変更内容を議論してください。

---

**注意**: このツールは個人的なプロジェクトです。Notionの公式ツールではなく、Notionによる保証もサポートもありません。APIの仕様変更によって動作しなくなる可能性があります。
